<template lang="html">
    <v-app light>

      <v-toolbar fixed :dark="true" :prominent="true" class="blue darken-4">

            <img src="../../public/Logo.png" style="width: 50px; height: auto; padding-bottom: 5px">

          <v-toolbar-title v-text="title" class="white--text">
          </v-toolbar-title>
          <v-spacer></v-spacer>
          <v-toolbar-items>
            <a class="text-xs-right hidden-sm-and-down" href='http://play.google.com/store/monkeyfit?pcampaignid=MKT-Other-global-all-co-prtnr-py-PartBadge-Mar2515-1'>
              <img alt='Disponible en Google Play' style="width: 25%" src='https://play.google.com/intl/en_us/badges/images/generic/es-419_badge_web_generic.png'/>
            </a>
          </v-toolbar-items>
      </v-toolbar>
      <main>
        <v-carousel>
          <carousel-text :place-name="gym.name" :place-sum="gym.sum">
          </carousel-text>
          <v-carousel-item v-for="(item,i) in pictures" :src="item.src" :key="i"></v-carousel-item>
        </v-carousel>


        <v-container fluid grid-list-md class="grey lighten-4">

          <v-layout row wrap class="mb-4">
                  <v-flex xs12 sm6>
                    <infor-card
                      :placeAddress="gym.address"
                      :placePhone1="gym.phone1"
                      :placePhone2="gym.phone2"
                      :placewhatsapp="gym.wsp"
                      :placeWeb="gym.web"
                      :placeFacebook="gym.fb"
                      :placeInstagram="gym.insta"
                      :PlaceYoutube="gym.yt"
                      :placeTwitter="gym.twit"
                      :placeSports="gym.sports"
                      :placeThumbsup="gym.thumbs"
                      :placePublic="gym.public"
                      :placeScore="gym.score"
                      >

                    </infor-card>
                  </v-flex>
                  <v-flex xs12 sm6>
                      <v-card height="315px">
                          <v-card-title>
                              Ubicacion
                          </v-card-title>
                          <v-layout row wrap>
                                <div class="ma-2 pa-2">
                                    <gmap-map
                                        v-if="gym.lat !== undefined && gym.lon !== undefined"
                                        :center="{lat:gym.lat, lng: gym.lon}"
                                        :zoom="12"
                                        map-type-id="terrain"
                                        style="width: 98%; height: 250px; position: absolute; left:6px; top:50px;"
                                    >
                                        <gmap-marker
                                            :position="{lat:gym.lat, lng: gym.lon}"
                                            :clickable="true"
                                            :draggable="false"
                                            @click="center={lat:gym.lat, lng: gym.lon}"
                                        ></gmap-marker>
                                  </gmap-map>
                                </div>
                          </v-layout>
                      </v-card>
                  </v-flex>
          </v-layout>
          <h4>Experiencias</h4>
    <!--Checkins-->
            <v-layout row wrap>
                <v-flex
                  v-bind="{ [`xs${12} sm${checkin.length > 100 ? 6 : 4}`]: true }"
                  v-for="(checkin, i) in checkins"
                  :key="i"
                >
                  <checkin-card
                    :checkinId="i"
                    :checkinsLength="checkins.length"
                    :checkinAuthor="checkin.full_username"
                    :checkinProfPic="checkin.profile_image"
                    :checkinImgUrl="checkin.checkin_image"
                    :checkinText="checkin.comment"
                    :checkinDate="checkin.timesince"
                    @click.native.stop="onClickCheckinCard(i)"
                    >
                  </checkin-card>
                </v-flex>
            </v-layout>

        </v-container>
      </main>
      <v-footer :fixed="false">
        <span>monkeyfit &copy; 2017</span>
      </v-footer>

      <v-dialog v-model="dialog"  persistent width="50%">
        <v-card>
          <v-layout row>
              <v-flex sm1 class="dialog-arrows">
                  <template v-if = "checkinInDialog.checkinId > 0" >
                      <v-icon x-large v-on:click="goPrev(checkinInDialog.checkinId)">chevron_left</v-icon>
                  </template>

              </v-flex>
              <v-flex xs12 sm10>

                  <v-layout row>
                      <v-flex xs2 class="text-xs-right">
                          <v-avatar style="margin: 10px;"
                                    v-if="checkinInDialog.checkinProfPic === null || checkinInDialog.checkinProfPic === undefined">

                                <img src="../../public/Profpic_default.png" height="50px" weight="auto">
                                </img>
                          </v-avatar>
                          <v-avatar v-else >
                              <img
                                    :src="checkinInDialog.checkinProfPic"
                                    height="50px"
                                    weight="auto"
                                    style="margin: 10px"

                                >
                              </img>
                          </v-avatar>
                      </v-flex>
                    <v-flex xs10>
                      <div>
                        <div class="headline">{{checkinInDialog.checkinAuthor}}</div>
                      </div>
                    </v-flex>
                  </v-layout>
                  <v-card-media
                  :src="checkinInDialog.checkinImgUrl"
                  height="400px"
                  weight="auto"
                  >
                  </v-card-media>
                  <v-card-text>
                      <div><h6>{{ checkinInDialog.checkinText }}</h6></div>
                  </v-card-text>
              </v-flex>
              <v-flex sm1 class="dialog-arrows">
                  <template v-if = "checkinInDialog.checkinId < (checkinInDialog.checkinLength - 1)">
                      <v-icon x-large @click.native="goNext(checkinInDialog.checkinId)">chevron_right</v-icon>
                  </template>
              </v-flex>
          </v-layout row>
        </v-card>
      </v-dialog>
    </v-app>
</template>

<script>
import CarouselText from '../components/CarouselText.vue'
import CheckinCard from '../components/CheckinCard.vue'
import InforCard from '../components/InforCard.vue'
export default {
    name: 'Main',
    components: {
        CarouselText, CheckinCard, InforCard
    },
    data () {
      return {
        title: 'monkeyfit',
        fixed: true,
        startCheckinsPathUrl: "https://monkeyfit-test.herokuapp.com/api/v1.1/check-in/place/",
        placePathUrl: "academia-de-natacion-angel-romero",
        startPlaceUrl: "https://monkeyfit-test.herokuapp.com/api/v1.1/places/",
        formatJsonUrl: "/?format=json",
        endPhotosUrl:"/photos",
        placeUrl: "",
        checkinsUrl: "",
        PhotosUrl:"",
        pictures: [
            { src: "../public/4.png" },
            { src: "../public/4.png" }
        ],
        checkins: [],
        gym: {},
        dialog: false,
        checkinInDialog: {
            checkinId: 0,
            checkinLength: 1,
            checkinProfPic: "",
            checkinAuthor: "",
            checkinImgUrl: "",
            checkinText: ""
        }
      }
    },
    methods: {
        setCarouselImages: function (pictures) {
            this.pictures = []
            this.pictures = pictures
            console.log(pictures)

        },

        fetchGymPhoto: function () {

            let image_p = 0
            var p_images = [] // only p images
            var mix_images = [] // only p + c images
            this.$http.get(this.PhotosUrl)
            .then(function (res) {
                res.data.results.map(function (image) {
                    if (image.photo_type === 'P') {
                        image_p++
                        p_images.push({ src: image.photo_url})
                        mix_images.push({ src: image.photo_url})
                    } else if(image.photo_type === 'C') {
                        mix_images.push({ src: image.photo_url})
                    }
                })
                console.log("*** image_p")
                console.log(mix_images)
                if (image_p > 2) {
                    this.setCarouselImages(p_images)
                } else {
                    this.setCarouselImages(mix_images)
                }
            })
            .catch(function (err) {

            })
        },

        fetchGymInfo: function () {
            // this.gym = { name: "ASQWE", schedule: "45/78" }
            this.gym = {}
            this.$http.get(this.placeUrl).then(res => {
                this.gym.name = res.data.place_name
                this.gym.address = res.data.full_address
                this.gym.lon = Number(res.data.longitude)
                this.gym.lat = Number(res.data.latitude)
                this.gym.imageUrl = res.data.place_image
                this.gym.phone1 = res.data.telephone1
                this.gym.phone2 = res.data.telephone2
                this.gym.wsp = res.data.whatsapp
                this.gym.web = res.data.webpage
                this.gym.fb = res.data.facebook_url
                this.gym.insta = res.data.instagram_url
                this.gym.yt = res.data.youtube_url
                this.gym.twit = res.data.twitter_url
                this.gym.sum = res.data.summary
                this.gym.thumbs = res.data.thumbsup_counter
                this.gym.sports = res.data.sports
                this.gym.public = res.data.is_public_place
                this.gym.score = res.data.review_score

                let pictures = []
                pictures.push({ src: this.gym.imageUrl })
                // this.setCarouselImages(pictures)

               this.fetchGymPhoto()

            }, err => {

            })
        },
        fetchChekins: function () {
            // this.checkins = [
            //     { text: "abc", imageUrl: "", author: "xyz", date: "15/78/91" },
            //     { text: "abc", imageUrl: "", author: "xyz", date: "15/78/91" },
            //     { text: "abc", imageUrl: "asdads", author: "xyz", date: "15/78/91" },
            //     { text: "abc", imageUrl: "asdads", author: "xyz", date: "15/78/91" },
            //     { text: "abc", imageUrl: "asdads", author: "xyz", date: "15/78/91" }
            // ]
            var self = this
            this.$http.get(this.checkinsUrl).then(res => {

                res.data.results.map(function (checkinItem) {
                    self.checkins.push(checkinItem)
                })

            }, err => {

            })
        },
        onClickCheckinCard: function (index) {

            this.checkinInDialog = {}

            this.checkinInDialog.checkinId = index
            this.checkinInDialog.checkinLength = this.checkins.length
            this.checkinInDialog.checkinProfPic = this.checkins[index].profile_image
            this.checkinInDialog.checkinAuthor = this.checkins[index].full_username
            this.checkinInDialog.checkinImgUrl = this.checkins[index].checkin_image
            this.checkinInDialog.checkinText = this.checkins[index].comment

            // console.log(this.checkinInDialog.checkinId);
            // console.log(this.checkinInDialog.checkinId < this.checkinInDialog.checkinLength)

            this.dialog = true
        },
        goPrev: function (index) {
            // this.checkinId
            console.log("goPrev");

            console.log(this.checkinInDialog.checkinText)
            if (this.checkinInDialog.checkinId !== 0) {

                this.checkinInDialog.checkinId = index-1
                this.checkinInDialog.checkinLength = this.checkins.length
                this.checkinInDialog.checkinProfPic = this.checkins[index-1].profile_image
                this.checkinInDialog.checkinAuthor = this.checkins[index-1].full_username
                this.checkinInDialog.checkinImgUrl = this.checkins[index-1].checkin_image
                this.checkinInDialog.checkinText = this.checkins[index-1].comment
            }
            console.log(this.checkinInDialog.checkinText)

        },
        goNext: function (index) {
            console.log("goNext");
            // this.dialog = false
            if (index < (this.checkins.length-1)) {

                this.checkinInDialog.checkinId = index+1
                this.checkinInDialog.checkinLength = this.checkins.length
                this.checkinInDialog.checkinProfPic = this.checkins[index+1].profile_image
                this.checkinInDialog.checkinAuthor = this.checkins[index+1].full_username
                this.checkinInDialog.checkinImgUrl = this.checkins[index+1].checkin_image
                this.checkinInDialog.checkinText = this.checkins[index+1].comment
            }
        }
    },
    created: function () {

        this.placeUrl = this.startPlaceUrl + (this.$route.params.param_id || this.placePathUrl) + this.formatJsonUrl
        this.checkinsUrl = this.startCheckinsPathUrl + (this.$route.params.param_id || this.placePathUrl) + this.formatJsonUrl
        this.PhotosUrl = this.startPlaceUrl + (this.$route.params.param_id || this.placePathUrl) + this.endPhotosUrl + this.formatJsonUrl

        this.fetchChekins()
        this.fetchGymInfo()

        // MAX >>> AQUI RECIBES EL ID DEL POST / CHECKIN LO QUE SEA QUE DEBIA ESTAR AQUI
        // console.log(this.$route.params)
    }
}
</script>

<style lang="css">
</style>
